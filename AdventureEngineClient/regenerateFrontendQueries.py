import os
import re
import pprint

tsTypesDirectory = "types/coreTypes"
tsTypeImportsFile = "types/appTypes/appTypes"
queriesTargetDirectory = "queries/"
typeNames = [os.fsdecode(file).replace('.ts', '') for file in os.listdir(tsTypesDirectory + "/")]

autogeneratedWarningMessage = [
    '//*** CAUTION ***',
    '//This is an autogenerated file produced by regenerateFrontendQueries.py.',
    '//Edits made here will not persist after regeneration.',
]

def indentLineBlock(lines: list):
        return ['   ' + line for line in lines]


def main():
    queriesTarget = os.path.dirname(queriesTargetDirectory)
    if not os.path.exists(queriesTarget):
        os.makedirs(queriesTarget)
    
    fileLines = [
        *autogeneratedWarningMessage,
        '',
        'import { AppTypes } from "../' + tsTypeImportsFile + '";',
        '',
        'export type ServiceInterface<T> = {',
        *indentLineBlock([
            'getAllItems: () => Promise<Array<T>>',
            'getItemById: (id: number) => Promise<T>',
            'saveItem: (item: T) => Promise<T>'
        ]),
        '}',
        '',
        'export type QueryServicesType = {[key in keyof typeof AppTypes]: ServiceInterface<typeof AppTypes[key]>}',
        '',
        'export function composeQueryContext<',
        *indentLineBlock([
            '//Type templating',
            'QueryHandlerType extends <T>(opts: {',
            *indentLineBlock([
                'key: string[]', 
                'query: (...args : any[]) => Promise<T>'
            ]),
            '//Covering a generic query return',
            '}) => Record<string, T | any>'
        ]),
        '>(',
        *indentLineBlock([
            '//Arguments/dependencies',
            'queryHandler: QueryHandlerType,', 
            'services: QueryServicesType'
        ]),
        ') {',
        *indentLineBlock([
            'return {',
            *indentLineBlock([
                *[item for sublist in [produceQueryLinesForType(typeName) for typeName in typeNames] for item in sublist],
            ]),
            '}'
        ]),
        '}'    
    ]
            
    f = open(queriesTargetDirectory + "/queries.ts", 'w')
    f.writelines([i + '\n' for i in fileLines])
    f.close()
    
    print("Frontend queries successfully generated.")


def produceQueryLinesForType(typeName: str):
    #this should eventually be brought out to config
    baseApiUrl = "http://localhost:8080/"

    def produceGetCollectionQuery(tableName: str):
        lines = [
            'query' + tableName + 's: () => queryHandler({',
                *indentLineBlock([
                    'key: ["' + tableName + 's"],',
                    'query: () => services.' + tableName + '.getAllItems()',
                ]),
            '}),',
        ]

        return lines
    

    lines = [
        *produceGetCollectionQuery(typeName),
    ]

    return lines


if __name__ == '__main__': main()